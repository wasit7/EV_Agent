<!-- templates/chat.html -->
{% extends "base.html" %}
{% block content %}
<div class="max-w-2xl mx-auto w-full p-4 flex flex-col h-full">
    <div class="flex-1 overflow-y-auto space-y-4 mb-4 bg-white p-4 rounded-lg shadow-inner border border-gray-200">
        {% if not chat_history %}
            <div class="text-center text-gray-400 mt-10">
                <p>Hello! I'm your EV Assistant.</p>
                <p class="text-sm">Try: "Book a Tesla" or "Onboard me (Name: John, Nickname: Johnny, License: 12345)"</p>
            </div>
        {% endif %}
        {% for msg in chat_history %}
            <div class="flex flex-col space-y-1 {% if msg.role == 'user' %}items-end{% else %}items-start{% endif %}">
                <div class="px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-sm
                    {% if msg.role == 'user' %}bg-blue-600 text-white rounded-br-none
                    {% else %}bg-gray-100 text-gray-800 rounded-bl-none border border-gray-200{% endif %}">
                    {{ msg.text }}
                </div>
            </div>
        {% endfor %}
        {% if draft_transaction %}
            <div class="w-full max-w-sm bg-white border border-blue-200 rounded-xl shadow-lg mt-4 mr-auto animate-pulse-once">
                <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="font-bold text-blue-800">üìù Confirm Request</h3>
                    <span class="text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">Draft</span>
                </div>
                <div class="p-4 text-sm space-y-2">
                    <p><strong>Car:</strong> {{ draft_transaction.car.model_name }}</p>
                    <p><strong>Price:</strong> ${{ draft_transaction.car.price_per_day }}/day</p>
                    <p><strong>Appointment:</strong> {{ draft_transaction.appointment_date }}</p>
                </div>
                <div class="p-3 bg-gray-50">
                    <form method="POST" action="{% url 'confirm_transaction' %}">
                        {% csrf_token %}
                        <input type="hidden" name="transaction_id" value="{{ draft_transaction.id }}">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg">Confirm</button>
                    </form>
                </div>
            </div>
        {% endif %}
        <div id="bottom"></div>
    </div>
    
    <!-- Updated Form with Input Clearing Logic -->
    <form method="POST" class="flex gap-2 bg-white p-2 rounded-xl border shadow-sm"
          onsubmit="setTimeout(() => this.reset(), 10)">
        {% csrf_token %}
        <input type="text" name="user_query" class="flex-1 bg-transparent border-none focus:ring-0 px-3" placeholder="Type your message..." autocomplete="off" autofocus required>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg">Send</button>
    </form>
    
    <script>window.onload=function(){document.getElementById('bottom').scrollIntoView();}</script>
</div>
{% endblock %}
